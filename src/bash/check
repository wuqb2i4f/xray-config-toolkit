#!/bin/bash

function check_configs() {
    local src_dir="$1"
    local num_total=$(count_items "$src_dir" "f")
    echo "Processing $num_total file(s) in $src_dir directory."
    local port_socks=10000
    local port_http=13000
    for iteration in {1..3}; do
        local num_count=0
        for file in "$src_dir"/*; do
            local filename=$(basename "$file")
            local pattern="^\[.*\] \[.*\] \[.*\]\.json$"
            if [[ ! $filename =~ $pattern ]]; then
                ((num_count++))
                local new_port_socks=$((port_socks + num_count))
                local new_port_http=$((port_http + num_count))
                sed -i -e "20s/[0-9]\+/$new_port_socks/" -e "36s/[0-9]\+/$new_port_http/" "$file"
                {
                    IFS=',' read -r response_check pid <<<"$(xray_connection_check "$file" true "$new_port_http")"
                    kill_process "$pid" >/dev/null 2>&1
                } &
                progress_bar "$num_count" "$num_total"
            fi
        done
        wait
    done
    echo -ne "\n"
}

function xray_connection_check() {
    local file="$1"
    local country="$2"
    local port="$3"
    $XRAY_APP run -c "$file" >/dev/null 2>&1 &
    local pid=$!
    sleep 15
    local attempts=0
    local response_check=false
    while ((attempts < 3)); do
        sleep 2
        local response_curl=$(curl -x http://127.0.0.1:"$port" -s -m 10 https://api.country.is)
        if [[ -n "$response_curl" && $(jq -r '.country' <<<"$response_curl") != "null" ]]; then
            if [[ "$country" == true ]]; then
                sed -i -e "20s/[0-9]\+/10808/" -e "36s/[0-9]\+/10809/" "$file"
                append_country_code_to_filename "$file" "$response_curl"
            fi
            response_check=true
            break
        fi
        ((attempts++))
    done
    echo "$response_check,$pid"
}

function append_country_code_to_filename() {
    local file="$1"
    local response_curl="$2"
    local filename=$(basename "$file")
    local filedir=$(dirname "$file")
    local pattern="^\[.*\] \[.*\] \[.*\]\.json$"
    if [[ ! $filename =~ $pattern ]]; then
        local country_code=$(jq -r '.country' <<<"$response_curl" | tr '[:upper:]' '[:lower:]')
        if [[ -z "$country_code" ]]; then
            country_code="un"
        fi
        declare -A emoji_flags=(["ad"]="ðŸ‡¦ðŸ‡©" ["ae"]="ðŸ‡¦ðŸ‡ª" ["af"]="ðŸ‡¦ðŸ‡«" ["ag"]="ðŸ‡¦ðŸ‡¬" ["ai"]="ðŸ‡¦ðŸ‡®" ["al"]="ðŸ‡¦ðŸ‡±" ["am"]="ðŸ‡¦ðŸ‡²" ["ao"]="ðŸ‡¦ðŸ‡´" ["ar"]="ðŸ‡¦ðŸ‡·" ["as"]="ðŸ‡¦ðŸ‡¸" ["at"]="ðŸ‡¦ðŸ‡¹" ["au"]="ðŸ‡¦ðŸ‡º" ["aw"]="ðŸ‡¦ðŸ‡¼" ["ax"]="ðŸ‡¦ðŸ‡½" ["az"]="ðŸ‡¦ðŸ‡¿" ["ba"]="ðŸ‡§ðŸ‡¦" ["bb"]="ðŸ‡§ðŸ‡§" ["bd"]="ðŸ‡§ðŸ‡©" ["be"]="ðŸ‡§ðŸ‡ª" ["bf"]="ðŸ‡§ðŸ‡«" ["bg"]="ðŸ‡§ðŸ‡¬" ["bh"]="ðŸ‡§ðŸ‡­" ["bi"]="ðŸ‡§ðŸ‡®" ["bj"]="ðŸ‡§ðŸ‡¯" ["bl"]="ðŸ‡§ðŸ‡±" ["bm"]="ðŸ‡§ðŸ‡²" ["bn"]="ðŸ‡§ðŸ‡³" ["bo"]="ðŸ‡§ðŸ‡´" ["bq"]="ðŸ‡§ðŸ‡¶" ["br"]="ðŸ‡§ðŸ‡·" ["bs"]="ðŸ‡§ðŸ‡¸" ["bt"]="ðŸ‡§ðŸ‡¹" ["bv"]="ðŸ‡§ðŸ‡»" ["bw"]="ðŸ‡§ðŸ‡¼" ["by"]="ðŸ‡§ðŸ‡¾" ["bz"]="ðŸ‡§ðŸ‡¿" ["ca"]="ðŸ‡¨ðŸ‡¦" ["cc"]="ðŸ‡¨ðŸ‡¨" ["cd"]="ðŸ‡¨ðŸ‡©" ["cf"]="ðŸ‡¨ðŸ‡«" ["cg"]="ðŸ‡¨ðŸ‡¬" ["ch"]="ðŸ‡¨ðŸ‡­" ["ci"]="ðŸ‡¨ðŸ‡®" ["ck"]="ðŸ‡¨ðŸ‡°" ["cl"]="ðŸ‡¨ðŸ‡±" ["cm"]="ðŸ‡¨ðŸ‡²" ["cn"]="ðŸ‡¨ðŸ‡³" ["co"]="ðŸ‡¨ðŸ‡´" ["cr"]="ðŸ‡¨ðŸ‡·" ["cu"]="ðŸ‡¨ðŸ‡º" ["cv"]="ðŸ‡¨ðŸ‡»" ["cw"]="ðŸ‡¨ðŸ‡¼" ["cx"]="ðŸ‡¨ðŸ‡½" ["cy"]="ðŸ‡¨ðŸ‡¾" ["cz"]="ðŸ‡¨ðŸ‡¿" ["de"]="ðŸ‡©ðŸ‡ª" ["dj"]="ðŸ‡©ðŸ‡¯" ["dk"]="ðŸ‡©ðŸ‡°" ["dm"]="ðŸ‡©ðŸ‡²" ["do"]="ðŸ‡©ðŸ‡´" ["dz"]="ðŸ‡©ðŸ‡¿" ["ec"]="ðŸ‡ªðŸ‡¨" ["ee"]="ðŸ‡ªðŸ‡ª" ["eg"]="ðŸ‡ªðŸ‡¬" ["eh"]="ðŸ‡ªðŸ‡­" ["er"]="ðŸ‡ªðŸ‡·" ["es"]="ðŸ‡ªðŸ‡¸" ["et"]="ðŸ‡ªðŸ‡¹" ["fi"]="ðŸ‡«ðŸ‡®" ["fj"]="ðŸ‡«ðŸ‡¯" ["fm"]="ðŸ‡«ðŸ‡²" ["fo"]="ðŸ‡«ðŸ‡´" ["fr"]="ðŸ‡«ðŸ‡·" ["ga"]="ðŸ‡¬ðŸ‡¦" ["gb"]="ðŸ‡¬ðŸ‡§" ["gd"]="ðŸ‡¬ðŸ‡©" ["ge"]="ðŸ‡¬ðŸ‡ª" ["gf"]="ðŸ‡¬ðŸ‡«" ["gg"]="ðŸ‡¬ðŸ‡¬" ["gh"]="ðŸ‡¬ðŸ‡­" ["gi"]="ðŸ‡¬ðŸ‡®" ["gl"]="ðŸ‡¬ðŸ‡±" ["gm"]="ðŸ‡¬ðŸ‡²" ["gn"]="ðŸ‡¬ðŸ‡³" ["gp"]="ðŸ‡¬ðŸ‡µ" ["gq"]="ðŸ‡¬ðŸ‡¶" ["gr"]="ðŸ‡¬ðŸ‡·" ["gt"]="ðŸ‡¬ðŸ‡¹" ["gu"]="ðŸ‡¬ðŸ‡º" ["gw"]="ðŸ‡¬ðŸ‡¼" ["gy"]="ðŸ‡¬ðŸ‡¾" ["hk"]="ðŸ‡­ðŸ‡°" ["hm"]="ðŸ‡­ðŸ‡²" ["hn"]="ðŸ‡­ðŸ‡³" ["hr"]="ðŸ‡­ðŸ‡·" ["ht"]="ðŸ‡­ðŸ‡¹" ["hu"]="ðŸ‡­ðŸ‡º" ["id"]="ðŸ‡®ðŸ‡©" ["ie"]="ðŸ‡®ðŸ‡ª" ["il"]="ðŸ‡®ðŸ‡±" ["im"]="ðŸ‡®ðŸ‡²" ["in"]="ðŸ‡®ðŸ‡³" ["io"]="ðŸ‡®ðŸ‡´" ["iq"]="ðŸ‡®ðŸ‡¶" ["ir"]="ðŸ‡®ðŸ‡·" ["is"]="ðŸ‡®ðŸ‡¸" ["it"]="ðŸ‡®ðŸ‡¹" ["je"]="ðŸ‡¯ðŸ‡ª" ["jm"]="ðŸ‡¯ðŸ‡²" ["jo"]="ðŸ‡¯ðŸ‡´" ["jp"]="ðŸ‡¯ðŸ‡µ" ["ke"]="ðŸ‡°ðŸ‡ª" ["kg"]="ðŸ‡°ðŸ‡¬" ["kh"]="ðŸ‡°ðŸ‡­" ["ki"]="ðŸ‡°ðŸ‡®" ["km"]="ðŸ‡°ðŸ‡²" ["kn"]="ðŸ‡°ðŸ‡³" ["kp"]="ðŸ‡°ðŸ‡µ" ["kr"]="ðŸ‡°ðŸ‡·" ["kw"]="ðŸ‡°ðŸ‡¼" ["ky"]="ðŸ‡°ðŸ‡¾" ["kz"]="ðŸ‡°ðŸ‡¿" ["la"]="ðŸ‡±ðŸ‡¦" ["lb"]="ðŸ‡±ðŸ‡§" ["lc"]="ðŸ‡±ðŸ‡¨" ["li"]="ðŸ‡±ðŸ‡®" ["lk"]="ðŸ‡±ðŸ‡°" ["lr"]="ðŸ‡±ðŸ‡·" ["ls"]="ðŸ‡±ðŸ‡¸" ["lt"]="ðŸ‡±ðŸ‡¹" ["lu"]="ðŸ‡±ðŸ‡º" ["lv"]="ðŸ‡±ðŸ‡»" ["ly"]="ðŸ‡±ðŸ‡¾" ["ma"]="ðŸ‡²ðŸ‡¦" ["mc"]="ðŸ‡²ðŸ‡¨" ["md"]="ðŸ‡²ðŸ‡©" ["me"]="ðŸ‡²ðŸ‡ª" ["mf"]="ðŸ‡²ðŸ‡«" ["mg"]="ðŸ‡²ðŸ‡¬" ["mh"]="ðŸ‡²ðŸ‡­" ["mk"]="ðŸ‡²ðŸ‡°" ["ml"]="ðŸ‡²ðŸ‡±" ["mm"]="ðŸ‡²ðŸ‡²" ["mn"]="ðŸ‡²ðŸ‡³" ["mo"]="ðŸ‡²ðŸ‡´" ["mp"]="ðŸ‡²ðŸ‡µ" ["mq"]="ðŸ‡²ðŸ‡¶" ["mr"]="ðŸ‡²ðŸ‡·" ["ms"]="ðŸ‡²ðŸ‡¸" ["mt"]="ðŸ‡²ðŸ‡¹" ["mu"]="ðŸ‡²ðŸ‡º" ["mv"]="ðŸ‡²ðŸ‡»" ["mw"]="ðŸ‡²ðŸ‡¼" ["mx"]="ðŸ‡²ðŸ‡½" ["my"]="ðŸ‡²ðŸ‡¾" ["mz"]="ðŸ‡²ðŸ‡¿" ["na"]="ðŸ‡³ðŸ‡¦" ["nc"]="ðŸ‡³ðŸ‡¨" ["ne"]="ðŸ‡³ðŸ‡ª" ["nf"]="ðŸ‡³ðŸ‡«" ["ng"]="ðŸ‡³ðŸ‡¬" ["ni"]="ðŸ‡³ðŸ‡®" ["nl"]="ðŸ‡³ðŸ‡±" ["no"]="ðŸ‡³ðŸ‡´" ["np"]="ðŸ‡³ðŸ‡µ" ["nr"]="ðŸ‡³ðŸ‡·" ["nu"]="ðŸ‡³ðŸ‡º" ["nz"]="ðŸ‡³ðŸ‡¿" ["om"]="ðŸ‡´ðŸ‡²" ["pa"]="ðŸ‡µðŸ‡¦" ["pe"]="ðŸ‡µðŸ‡ª" ["pf"]="ðŸ‡µðŸ‡«" ["pg"]="ðŸ‡µðŸ‡¬" ["ph"]="ðŸ‡µðŸ‡­" ["pk"]="ðŸ‡µðŸ‡°" ["pl"]="ðŸ‡µðŸ‡±" ["pm"]="ðŸ‡µðŸ‡²" ["pn"]="ðŸ‡µðŸ‡³" ["pr"]="ðŸ‡µðŸ‡·" ["pt"]="ðŸ‡µðŸ‡¹" ["pw"]="ðŸ‡µðŸ‡¼" ["py"]="ðŸ‡µðŸ‡¾" ["qa"]="ðŸ‡¶ðŸ‡¦" ["re"]="ðŸ‡·ðŸ‡ª" ["ro"]="ðŸ‡·ðŸ‡´" ["rs"]="ðŸ‡·ðŸ‡¸" ["ru"]="ðŸ‡·ðŸ‡º" ["rw"]="ðŸ‡·ðŸ‡¼" ["sa"]="ðŸ‡¸ðŸ‡¦" ["sb"]="ðŸ‡¸ðŸ‡§" ["sc"]="ðŸ‡¸ðŸ‡¨" ["sd"]="ðŸ‡¸ðŸ‡©" ["se"]="ðŸ‡¸ðŸ‡ª" ["sg"]="ðŸ‡¸ðŸ‡¬" ["sh"]="ðŸ‡¸ðŸ‡­" ["si"]="ðŸ‡¸ðŸ‡®" ["sj"]="ðŸ‡¸ðŸ‡¯" ["sk"]="ðŸ‡¸ðŸ‡°" ["sl"]="ðŸ‡¸ðŸ‡±" ["sm"]="ðŸ‡¸ðŸ‡²" ["sn"]="ðŸ‡¸ðŸ‡³" ["so"]="ðŸ‡¸ðŸ‡´" ["sr"]="ðŸ‡¸ðŸ‡·" ["ss"]="ðŸ‡¸ðŸ‡¸" ["st"]="ðŸ‡¸ðŸ‡¹" ["sv"]="ðŸ‡¸ðŸ‡»" ["sx"]="ðŸ‡¸ðŸ‡½" ["sy"]="ðŸ‡¸ðŸ‡¾" ["sz"]="ðŸ‡¸ðŸ‡¿" ["t1"]="ðŸ‡ºðŸ‡³" ["tc"]="ðŸ‡¹ðŸ‡¨" ["td"]="ðŸ‡¹ðŸ‡©" ["tf"]="ðŸ‡¹ðŸ‡«" ["tg"]="ðŸ‡¹ðŸ‡¬" ["th"]="ðŸ‡¹ðŸ‡­" ["tj"]="ðŸ‡¹ðŸ‡¯" ["tk"]="ðŸ‡¹ðŸ‡°" ["tl"]="ðŸ‡¹ðŸ‡±" ["tm"]="ðŸ‡¹ðŸ‡²" ["tn"]="ðŸ‡¹ðŸ‡³" ["to"]="ðŸ‡¹ðŸ‡´" ["tr"]="ðŸ‡¹ðŸ‡·" ["tt"]="ðŸ‡¹ðŸ‡¹" ["tv"]="ðŸ‡¹ðŸ‡»" ["tw"]="ðŸ‡¹ðŸ‡¼" ["tz"]="ðŸ‡¹ðŸ‡¿" ["ua"]="ðŸ‡ºðŸ‡¦" ["ug"]="ðŸ‡ºðŸ‡¬" ["um"]="ðŸ‡ºðŸ‡²" ["un"]="ðŸ‡ºðŸ‡³" ["us"]="ðŸ‡ºðŸ‡¸" ["uy"]="ðŸ‡ºðŸ‡¾" ["uz"]="ðŸ‡ºðŸ‡¿" ["va"]="ðŸ‡»ðŸ‡¦" ["vc"]="ðŸ‡»ðŸ‡¨" ["ve"]="ðŸ‡»ðŸ‡ª" ["vg"]="ðŸ‡»ðŸ‡¬" ["vi"]="ðŸ‡»ðŸ‡®" ["vn"]="ðŸ‡»ðŸ‡³" ["vu"]="ðŸ‡»ðŸ‡º" ["wf"]="ðŸ‡¼ðŸ‡«" ["ws"]="ðŸ‡¼ðŸ‡¸" ["ye"]="ðŸ‡¾ðŸ‡ª" ["yt"]="ðŸ‡¾ðŸ‡¹" ["za"]="ðŸ‡¿ðŸ‡¦" ["zm"]="ðŸ‡¿ðŸ‡²" ["zw"]="ðŸ‡¿ðŸ‡¼")
        local emoji_flag=${emoji_flags[$country_code]:-$country_code}
        local filerename=$(sed -E "s/^(\[[^]]+])( \[[^]]+])(.json)$/\[$emoji_flag] \1\2\3/" <<<"$filename")
        mv -f "$file" "$filedir/$filerename"
    fi
}
